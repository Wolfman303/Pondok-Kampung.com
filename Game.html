<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tower Defense Game</title>
  <style>
    body {
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #222;
      color: white;
      font-family: sans-serif;
    }
    canvas {
      background: #333;
      border: 2px solid #fff;
      display: block;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="800" height="500"></canvas>
  <script>
    const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

let towers = [];
let enemies = [];
let bullets = [];
let money = 100;
let lives = 10;
let wave = 1;
let gameRunning = true;

const path = [
  {x:0,y:200},{x:200,y:200},{x:200,y:400},
  {x:600,y:400},{x:600,y:100},{x:800,y:100}
];

// ==== Classes ====
class Enemy {
  constructor() {
    this.x = path[0].x;
    this.y = path[0].y;
    this.hp = 50 + wave * 10;
    this.speed = 1 + wave * 0.2;
    this.pathIndex = 0;
    this.radius = 10;
  }
  move() {
    let target = path[this.pathIndex+1];
    if(!target) {
      lives--;
      return false;
    }
    let dx = target.x - this.x;
    let dy = target.y - this.y;
    let dist = Math.sqrt(dx*dx + dy*dy);
    if(dist < this.speed) {
      this.x = target.x;
      this.y = target.y;
      this.pathIndex++;
    } else {
      this.x += dx/dist * this.speed;
      this.y += dy/dist * this.speed;
    }
    return true;
  }
  draw() {
    ctx.fillStyle = "red";
    ctx.beginPath();
    ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);
    ctx.fill();
    // HP bar
    ctx.fillStyle="green";
    ctx.fillRect(this.x-10,this.y-15,20*(this.hp/(50+wave*10)),3);
  }
}

class Tower {
  constructor(x,y) {
    this.x=x;this.y=y;this.range=100;this.fireRate=60;this.cooldown=0;
  }
  update() {
    if(this.cooldown>0){this.cooldown--;return;}
    let target=enemies.find(e=>Math.hypot(e.x-this.x,e.y-this.y)<this.range);
    if(target){
      bullets.push(new Bullet(this.x,this.y,target));
      this.cooldown=this.fireRate;
    }
  }
  draw() {
    ctx.fillStyle="cyan";
    ctx.fillRect(this.x-10,this.y-10,20,20);
  }
}

class Bullet {
  constructor(x,y,target){
    this.x=x;this.y=y;this.target=target;this.speed=5;this.radius=5;
  }
  update(){
    if(!this.target)return false;
    let dx=this.target.x-this.x,dy=this.target.y-this.y;
    let dist=Math.sqrt(dx*dx+dy*dy);
    if(dist<this.speed){
      this.target.hp-=20;
      return false;
    }
    this.x+=dx/dist*this.speed;
    this.y+=dy/dist*this.speed;
    return true;
  }
  draw(){
    ctx.fillStyle="yellow";
    ctx.beginPath();
    ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);
    ctx.fill();
  }
}

// ==== Game Logic ====
function spawnWave(){
  for(let i=0;i<wave*3;i++){
    setTimeout(()=>enemies.push(new Enemy()),i*800);
  }
}

canvas.addEventListener("click",(e)=>{
  const rect=canvas.getBoundingClientRect();
  const x=e.clientX-rect.left;
  const y=e.clientY-rect.top;
  if(money>=50){
    towers.push(new Tower(x,y));
    money-=50;
  }
});

function drawPath(){
  ctx.strokeStyle="white";
  ctx.lineWidth=4;
  ctx.beginPath();
  ctx.moveTo(path[0].x,path[0].y);
  for(let p of path)ctx.lineTo(p.x,p.y);
  ctx.stroke();
}

function gameLoop(){
  if(!gameRunning)return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawPath();

  // update enemies
  enemies = enemies.filter(e=>{
    if(!e.move()) return false;
    if(e.hp<=0){
      money+=10;
      return false;
    }
    e.draw();
    return true;
  });

  // update towers
  towers.forEach(t=>{t.update();t.draw();});

  // update bullets
  bullets=bullets.filter(b=>{let alive=b.update();b.draw();return alive;});

  // UI
  ctx.fillStyle="white";
  ctx.fillText(`Money: ${money}`,10,20);
  ctx.fillText(`Lives: ${lives}`,10,40);
  ctx.fillText(`Wave: ${wave}`,10,60);

  if(enemies.length===0 && lives>0){
    wave++;
    spawnWave();
  }

  if(lives<=0){
    gameRunning=false;
    ctx.fillStyle="red";
    ctx.font="30px sans-serif";
    ctx.fillText("GAME OVER",canvas.width/2-80,canvas.height/2);
  }

  requestAnimationFrame(gameLoop);
}

// Start langsung otomatis
spawnWave();
gameLoop();
  </script>
</body>
</html>
